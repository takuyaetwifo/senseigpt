<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">

  <!-- Prism.jsï¼ˆã‚³ãƒ¼ãƒ‰è¡¨ç¤ºã®æ•´å½¢ç”¨ï¼‰ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs/themes/prism.css">
  <script src="https://cdn.jsdelivr.net/npm/prismjs/prism.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-python.min.js"></script>

<!-- DOM èª­ã¿è¾¼ã¿å¾Œã« 1 å›ã ã‘å‘¼ã¶ -->
  <script>
  document.addEventListener("DOMContentLoaded", () => Prism.highlightAll());
  </script>


  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">



  <title>ã›ã‚“ã›ã„GPT</title>
</head>

<body style="background-color: {{ theme_color }};">
  <div class="header">
    ãƒ­ã‚°ã‚¤ãƒ³ä¸­: {{ display_name }} ã•ã‚“ |
    <a href="{{ url_for('settings') }}">è¨­å®š</a>
    <a href="/logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
  </div>

  {% if session['role'] == 'admin' %}
  <a href="{{ url_for('admin_edit_profile', user_id=session['user_id']) }}">è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</a>
  {% endif %}

  <h2 style="display: flex;align-items: center; gap: 20px;">
    {% if user_icon %}
      <img src="{{ url_for('static', filename='uploads/' ~ user_icon) }}" alt="ã‚¢ã‚¤ã‚³ãƒ³" width="100" height="100" style="vertical-align: middle; border-radius: 50%;">
    {% endif %}
    ã›ã‚“ã›ã„GPT
    {% if lesson %}
      <span style="font-size: 16px; background-color: #eef; padding: 6px 10px; border-radius: 8px;">
        ğŸ“˜ ãã‚‡ã†ã®ãŠã¹ã‚“ãã‚‡ã†ï¼š{{ lesson }}
      </span>
    {% endif %}
  </h2>

  {% if birthday_today %}
  <div style="color: red; font-size: 1.2em; font-weight: bold;">
    ğŸ‚ ãŠèª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ç´ æ•µãª1æ—¥ã«ãªã‚Šã¾ã™ã‚ˆã†ã« ğŸ‰
  </div>
  {% endif %}





<form method="POST" action="/chat" onsubmit="return handleSend(this);" style="display: flex; align-items: center; gap: 8px; margin-bottom: 14px;">
  <input type="text" name="message" required style="flex:1; min-width: 120px; font-size: 1.1em; padding: 10px; border-radius: 10px; border: 1px solid #ccc;">
  <button type="submit" id="sendBtn" style="padding: 10px 20px; font-size: 1.05em; border-radius: 10px; background: #3399ff; color: #fff; border: none;">é€ä¿¡</button>
  <button
    type="button"
    id="latest-voice-btn"
    style="
      padding: 9px 18px;
      font-size: 1.05em;
      border-radius: 50px;
      background: linear-gradient(90deg, #27ae60 70%, #2ecc71 100%);
      color: #fff;
      border: none;
      box-shadow: 0 1px 6px rgba(34, 139, 34, 0.15);
      display: flex;
      align-items: center;
      gap: 4px;
      transition: background 0.2s;
    "
    onclick="playLatestVoice()"
  >
    <span style="font-size:1.25em;">â–¶ï¸</span>
    <span style="font-size:0.98em;">éŸ³å£°ã§èã</span>
  </button>
</form>
<audio id="zundamon-audio" hidden></audio>

<!-- éŸ³å£°ãƒ†ã‚¹ãƒˆç”¨ãƒœã‚¿ãƒ³ï¼ˆç”»é¢ã«ã¯å‡ºã•ãªã„ï¼‰ -->
<button id="voiceTestBtn" hidden onclick="playVoice('ã“ã‚“ã«ã¡ã¯ã€ãƒ†ã‚¹ãƒˆéŸ³å£°ã§ã™')">éŸ³å£°ãƒ†ã‚¹ãƒˆï¼ˆOpenAIï¼‰</button>
<!-- audioã‚¿ã‚°ã¯hiddenã§ã€‚display:noneã¯NG -->
<audio id="zundamon-audio" hidden></audio>


<script>
function playLatestVoice() {
  // æœ€æ–°ï¼ˆæœ€åˆï¼‰ã®å…ˆç”Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
  const gptMessages = document.querySelectorAll('.message.gpt');
  if (gptMessages.length === 0) return;
  // ä¸€ç•ªä¸ŠãŒæœ€æ–°ãªã®ã§[0]
  const first = gptMessages[0];
  // ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢
  let firstText = first.innerText
    .replace(/^å…ˆç”Ÿ:\s*/, "")
    .replace(/ğŸ“‹ ã‚³ãƒ”ãƒ¼.*/, "")
    .replace(/\n+/g, " ")
    .trim();
  playVoice(firstText);
}

function playVoice(text) {
  fetch('/voice_openai', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({text: text})
  })
  .then(res => res.blob())
  .then(blob => {
    const url = URL.createObjectURL(blob);
    const audio = document.getElementById("zundamon-audio");
    audio.src = url;
    audio.play();
  });
}
</script>

<script>
window.addEventListener('DOMContentLoaded', function() {
  // ãƒãƒ£ãƒƒãƒˆã®æœ€æ–°è¿”ç­”ã®è‡ªå‹•å†ç”Ÿ
  const gptMessages = document.querySelectorAll('.message.gpt');
  if (gptMessages.length > 0) {
    const first = gptMessages[0];
    let firstText = first.innerText
      .replace(/^å…ˆç”Ÿ:\s*/, "")
      .replace(/ğŸ“‹ ã‚³ãƒ”ãƒ¼.*/, "")
      .replace(/\n+/g, " ")
      .trim();
    playVoice(firstText);
  }

  // iPadã§è‡ªå‹•å†ç”ŸãŒåŠ¹ã‹ãªã„å ´åˆã€åˆå›ã ã‘ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚’è¦æ±‚ã™ã‚‹
  // â†’ ã‚‚ã—ã€Œå†ç”Ÿã•ã‚Œãªã„ï¼ã€ã¨ãªã£ãŸå ´åˆã¯ã€ä¸‹è¨˜ã®ã‚ˆã†ã«æ¡ˆå†…æ–‡ï¼‹ãƒœã‚¿ãƒ³è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆã‚‚ã§ãã¾ã™
  // document.getElementById('voiceTestBtn').hidden = false;
});

function playVoice(text) {
  fetch('/voice_openai', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({text: text})
  })
  .then(res => res.blob())
  .then(blob => {
    const url = URL.createObjectURL(blob);
    const audio = document.getElementById("zundamon-audio");
    audio.src = url;
    audio.play();
  });
}
</script>






  <form action="{{ url_for('clear_chat') }}" method="POST" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
    <button type="submit">å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤</button>

  </form>









  <div class="chat-log">
    {% if rows %}
      <ul>
        
        {% for row in rows %}
          <div class="message user"><strong>ã‚ãªãŸ:</strong> {{ row.user_input }}</div><br>
          <div class="message gpt"><strong>å…ˆç”Ÿ:</strong> {{ row.gpt_response | safe }}</div>
        {% endfor %}
      </ul>
    {% endif %}
  </div>

<script>
function copyToClipboard(button) {
  const code = button.nextElementSibling.querySelector("code");
  if (!code) return;
  const text = code.innerText;
  navigator.clipboard.writeText(text).then(() => {
    button.textContent = "âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼";
    setTimeout(() => {
      button.textContent = "ğŸ“‹ ã‚³ãƒ”ãƒ¼";
    }, 1500);
  });
}

// é€£ç¶šé€ä¿¡é˜²æ­¢ï¼‹ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ã‚¤ã‚³ãƒ³
function handleSend(form) {
  const btn = form.querySelector('button[type="submit"]');
  btn.disabled = true;
  btn.innerHTML = 'é€ä¿¡ä¸­â€¦ <span class="loader"></span>';
  return true;
}
</script>




<!--

<script>
window.addEventListener('DOMContentLoaded', function() {
  // 1. localStorageã‹ã‚‰çŠ¶æ…‹å–å¾—ï¼ˆåˆå›ã¯ONï¼‰
  let voiceEnabled = localStorage.getItem('voiceEnabled');
  if (voiceEnabled === null) {
    voiceEnabled = "true";
    localStorage.setItem('voiceEnabled', "true");
  }
  voiceEnabled = (voiceEnabled === "true");

  // 2. ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’å¿…ãšlocalStorageã«åˆã‚ã›ã‚‹ï¼ˆã“ã“ãŒé‡è¦ï¼ï¼‰
  const voiceToggleBtn = document.getElementById('voice-toggle');
  if (voiceToggleBtn) {
    // localStorageã®å€¤ã‚’æ¯å›åæ˜ 
    voiceToggleBtn.textContent = voiceEnabled ? "ğŸ”Š éŸ³å£°ON" : "ğŸ”‡ éŸ³å£°OFF";
    // åˆ‡ã‚Šæ›¿ãˆãŸæ™‚ã‚‚åæ˜ 
    voiceToggleBtn.onclick = function() {
      voiceEnabled = !voiceEnabled;
      localStorage.setItem('voiceEnabled', voiceEnabled ? "true" : "false");
      this.textContent = voiceEnabled ? "ğŸ”Š éŸ³å£°ON" : "ğŸ”‡ éŸ³å£°OFF";
    };
  }

  // 3. éŸ³å£°è‡ªå‹•å†ç”Ÿã‚‚ONã®ã¨ãã ã‘
  const gptMessages = document.querySelectorAll('.message.gpt');
  if (gptMessages.length > 0 && voiceEnabled) {
    const first = gptMessages[0];
    let firstText = first.innerText
      .replace(/^å…ˆç”Ÿ:\s*/, "")
      .replace(/ğŸ“‹ ã‚³ãƒ”ãƒ¼.*/,"")
      .replace(/\n+/g, " ")
      .trim();
    playVoice(firstText);
  }

  function playVoice(text) {
    fetch('/voice', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({text: text})
    })
    .then(response => response.blob())
    .then(blob => {
      const url = URL.createObjectURL(blob);
      const audio = document.getElementById("zundamon-audio");
      audio.src = url;
      audio.play();
    });
  }
});
</script>


-->

</body>
</html>
